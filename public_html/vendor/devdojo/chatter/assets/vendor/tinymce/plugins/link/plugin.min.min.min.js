tinymce.PluginManager.add("link",function(c){function d(e){return function(){var f=c.settings.link_list;"string"==typeof f?tinymce.util.XHR.send({url:f,success:function(g){e(tinymce.util.JSON.parse(g))}}):"function"==typeof f?f(e):e(f)}}function a(g,h,e){function f(i,j){return j=j||[],tinymce.each(i,function(l){var k={text:l.text||l.title};l.menu?k.menu=f(l.menu):(k.value=l.value,h&&h(k)),j.push(k)}),j}return f(g,e||[])}function b(e){function f(x){var y=q.find("#text");(!y.value()||x.lastControl&&y.value()==x.lastControl.text())&&y.value(x.control.text()),q.find("#href").value(x.control.value())}function g(y){var x=[];return tinymce.each(c.dom.select("a:not([href])"),function(z){var A=z.name||z.id;A&&x.push({text:A,value:"#"+A,selected:-1!=y.indexOf("#"+A)})}),x.length?(x.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:x,onselect:f}):void 0}function h(){!p&&0===n.text.length&&r&&this.parent().parent().find("#text")[0].value(this.value())}function i(y){var x=y.meta||{};t&&t.value(c.convertURL(this.value(),"href")),tinymce.each(y.meta,function(z,A){q.find("#"+A).value(z)}),x.text||h.call(this)}function j(z){var A=Q.getContent();if(/</.test(A)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(A)||-1==A.indexOf("href="))){return !1}if(z){var x,y=z.childNodes;if(0===y.length){return !1}for(x=y.length-1;x>=0;x--){if(3!=y[x].nodeType){return !1}}}return !0}var m,o,p,q,r,s,t,u,v,w,k,l,n={},Q=c.selection,R=c.dom;m=Q.getNode(),o=R.getParent(m,"a[href]"),r=j(),n.text=p=o?o.innerText||o.textContent:Q.getContent({format:"text"}),n.href=o?R.getAttrib(o,"href"):"",o?n.target=R.getAttrib(o,"target"):c.settings.default_link_target&&(n.target=c.settings.default_link_target),(l=R.getAttrib(o,"rel"))&&(n.rel=l),(l=R.getAttrib(o,"class"))&&(n["class"]=l),(l=R.getAttrib(o,"title"))&&(n.title=l),r&&(s={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){n.text=this.value()}}),e&&(t={type:"listbox",label:"Link list",values:a(e,function(x){x.value=c.convertURL(x.value||x.url,"href")},[{text:"None",value:""}]),onselect:f,value:c.convertURL(n.href,"href"),onPostRender:function(){t=this}}),c.settings.target_list!==!1&&(c.settings.target_list||(c.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),v={name:"target",type:"listbox",label:"Target",values:a(c.settings.target_list)}),c.settings.rel_list&&(u={name:"rel",type:"listbox",label:"Rel",values:a(c.settings.rel_list)}),c.settings.link_class_list&&(w={name:"class",type:"listbox",label:"Class",values:a(c.settings.link_class_list,function(x){x.value&&(x.textStyle=function(){return c.formatter.getCssText({inline:"a",classes:[x.value]})})})}),c.settings.link_title!==!1&&(k={name:"title",type:"textbox",label:"Title",value:n.title}),q=c.windowManager.open({title:"Insert link",data:n,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:i,onkeyup:h},s,k,g(n.href),t,u,v,w],onSubmit:function(A){function x(B,C){var D=c.selection.getRng();tinymce.util.Delay.setEditorTimeout(c,function(){c.windowManager.confirm(B,function(E){c.selection.setRng(D),C(E)})})}function y(){var B={href:z,target:n.target?n.target:null,rel:n.rel?n.rel:null,"class":n["class"]?n["class"]:null,title:n.title?n.title:null};o?(c.focus(),r&&n.text!=p&&("innerText" in o?o.innerText=n.text:o.textContent=n.text),R.setAttribs(o,B),Q.select(o),c.undoManager.add()):r?c.insertContent(R.createHTML("a",B,R.encode(n.text))):c.execCommand("mceInsertLink",!1,B)}var z;return n=tinymce.extend(n,A.data),(z=n.href)?z.indexOf("@")>0&&-1==z.indexOf("//")&&-1==z.indexOf("mailto:")?void x("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(B){B&&(z="mailto:"+z),y()}):c.settings.link_assume_external_targets&&!/^\w+:/i.test(z)||!c.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(z)?void x("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(B){B&&(z="http://"+z),y()}):void y():void c.execCommand("unlink")}})}c.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:d(b),stateSelector:"a[href]"}),c.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),c.addShortcut("Meta+K","",d(b)),c.addCommand("mceLink",d(b)),this.showDialog=b,c.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:d(b),stateSelector:"a[href]",context:"insert",prependToContext:!0})});