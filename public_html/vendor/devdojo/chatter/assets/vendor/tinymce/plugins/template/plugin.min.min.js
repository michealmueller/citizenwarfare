tinymce.PluginManager.add("template",function(j){function i(a){return function(){var b=j.settings.templates;return"function"==typeof b?void b(a):void ("string"==typeof b?tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}}):a(b))}}function p(a){function s(d){function h(t){if(-1==t.indexOf("<html>")){var w="";tinymce.each(j.contentCSS,function(c){w+='<link type="text/css" rel="stylesheet" href="'+j.documentBaseURI.toAbsolute(c)+'">'});var v=j.settings.body_class||"";-1!=v.indexOf("=")&&(v=j.getParam("body_class","","hash"),v=v[j.id]||""),t="<!DOCTYPE html><html><head>"+w+'</head><body class="'+v+'">'+t+"</body></html>"}t=m(t,"template_preview_replace_values");var u=r.find("iframe")[0].getEl().contentWindow.document;u.open(),u.write(t),u.close()}var e=d.control.value();e.url?tinymce.util.XHR.send({url:e.url,success:function(b){q=b,h(q)}}):(q=e.content,h(q)),r.find("#description")[0].text(d.control.value().description)}var r,q,g=[];if(!a||0===a.length){var f=j.translate("No templates defined.");return void j.notificationManager.open({text:f,type:"info"})}tinymce.each(a,function(b){g.push({selected:!g.length,text:b.title,value:{url:b.url,content:b.content,description:b.description}})}),r=j.windowManager.open({title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Templates",items:{type:"listbox",label:"Templates",name:"template",values:g,onselect:s}}]},{type:"label",name:"description",label:"Description",text:"\xa0"},{type:"iframe",flex:1,border:1}],onsubmit:function(){l(!1,q)},width:j.getParam("template_popup_width",600),height:j.getParam("template_popup_height",500)}),r.find("listbox")[0].fire("select")}function o(a,v){function u(e,d){if(e=""+e,e.length<d){for(var f=0;f<d-e.length;f++){e="0"+e}}return e}var t="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),s="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),r="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),q="January February March April May June July August September October November December".split(" ");return v=v||new Date,a=a.replace("%D","%m/%d/%Y"),a=a.replace("%r","%I:%M:%S %p"),a=a.replace("%Y",""+v.getFullYear()),a=a.replace("%y",""+v.getYear()),a=a.replace("%m",u(v.getMonth()+1,2)),a=a.replace("%d",u(v.getDate(),2)),a=a.replace("%H",""+u(v.getHours(),2)),a=a.replace("%M",""+u(v.getMinutes(),2)),a=a.replace("%S",""+u(v.getSeconds(),2)),a=a.replace("%I",""+((v.getHours()+11)%12+1)),a=a.replace("%p",""+(v.getHours()<12?"AM":"PM")),a=a.replace("%B",""+j.translate(q[v.getMonth()])),a=a.replace("%b",""+j.translate(r[v.getMonth()])),a=a.replace("%A",""+j.translate(s[v.getDay()])),a=a.replace("%a",""+j.translate(t[v.getDay()])),a=a.replace("%%","%")}function n(a){var f=j.dom,e=j.getParam("template_replace_values");k(f.select("*",a),function(b){k(e,function(c,d){f.hasClass(b,d)&&"function"==typeof e[d]&&e[d](b)})})}function m(a,d){return k(j.getParam(d),function(b,e){"function"==typeof b&&(b=b(e)),a=a.replace(new RegExp("\\{\\$"+e+"\\}","g"),b)}),a}function l(a,r){function q(g,c){return new RegExp("\\b"+c+"\\b","g").test(g.className)}var h,f,e=j.dom,d=j.selection.getContent();r=m(r,"template_replace_values"),h=e.create("div",null,r),f=e.select(".mceTmpl",h),f&&f.length>0&&(h=e.create("div",null),h.appendChild(f[0].cloneNode(!0))),k(e.select("*",h),function(c){q(c,j.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))&&(c.innerHTML=o(j.getParam("template_cdate_format",j.getLang("template.cdate_format")))),q(c,j.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(c.innerHTML=o(j.getParam("template_mdate_format",j.getLang("template.mdate_format")))),q(c,j.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(c.innerHTML=d)}),n(h),j.execCommand("mceInsertContent",!1,h.innerHTML),j.addVisual()}var k=tinymce.each;j.addCommand("mceInsertTemplate",l),j.addButton("template",{title:"Insert template",onclick:i(p)}),j.addMenuItem("template",{text:"Insert template",onclick:i(p),context:"insert"}),j.on("PreProcess",function(a){var d=j.dom;k(d.select("div",a.node),function(c){d.hasClass(c,"mceTmpl")&&(k(d.select("*",c),function(e){d.hasClass(e,j.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(e.innerHTML=o(j.getParam("template_mdate_format",j.getLang("template.mdate_format"))))}),n(c))})})});