tinymce.PluginManager.add("link",function(f){function e(a){return function(){var b=f.settings.link_list;"string"==typeof b?tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}}):"function"==typeof b?b(a):a(b)}}function h(j,i,l){function k(b,d){return d=d||[],tinymce.each(b,function(c){var m={text:c.text||c.title};c.menu?m.menu=k(c.menu):(m.value=c.value,i&&i(m)),d.push(m)}),d}return k(j,l||[])}function g(P){function O(i){var d=G.find("#text");(!d.value()||i.lastControl&&d.value()==i.lastControl.text())&&d.value(i.control.text()),G.find("#href").value(i.control.value())}function N(d){var i=[];return tinymce.each(f.dom.select("a:not([href])"),function(b){var j=b.name||b.id;j&&i.push({text:j,value:"#"+j,selected:-1!=d.indexOf("#"+j)})}),i.length?(i.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:i,onselect:O}):void 0}function M(){!H&&0===x.text.length&&F&&this.parent().parent().find("#text")[0].value(this.value())}function L(d){var i=d.meta||{};D&&D.value(f.convertURL(this.value(),"href")),tinymce.each(d.meta,function(k,j){G.find("#"+j).value(k)}),i.text||M.call(this)}function K(j){var i=c.getContent();if(/</.test(i)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(i)||-1==i.indexOf("href="))){return !1}if(j){var l,k=j.childNodes;if(0===k.length){return !1}for(l=k.length-1;l>=0;l--){if(3!=k[l].nodeType){return !1}}}return !0}var J,I,H,G,F,E,D,C,B,A,z,y,x={},c=f.selection,a=f.dom;J=c.getNode(),I=a.getParent(J,"a[href]"),F=K(),x.text=H=I?I.innerText||I.textContent:c.getContent({format:"text"}),x.href=I?a.getAttrib(I,"href"):"",I?x.target=a.getAttrib(I,"target"):f.settings.default_link_target&&(x.target=f.settings.default_link_target),(y=a.getAttrib(I,"rel"))&&(x.rel=y),(y=a.getAttrib(I,"class"))&&(x["class"]=y),(y=a.getAttrib(I,"title"))&&(x.title=y),F&&(E={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){x.text=this.value()}}),P&&(D={type:"listbox",label:"Link list",values:h(P,function(d){d.value=f.convertURL(d.value||d.url,"href")},[{text:"None",value:""}]),onselect:O,value:f.convertURL(x.href,"href"),onPostRender:function(){D=this}}),f.settings.target_list!==!1&&(f.settings.target_list||(f.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),B={name:"target",type:"listbox",label:"Target",values:h(f.settings.target_list)}),f.settings.rel_list&&(C={name:"rel",type:"listbox",label:"Rel",values:h(f.settings.rel_list)}),f.settings.link_class_list&&(A={name:"class",type:"listbox",label:"Class",values:h(f.settings.link_class_list,function(d){d.value&&(d.textStyle=function(){return f.formatter.getCssText({inline:"a",classes:[d.value]})})})}),f.settings.link_title!==!1&&(z={name:"title",type:"textbox",label:"Title",value:x.title}),G=f.windowManager.open({title:"Insert link",data:x,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:L,onkeyup:M},E,z,N(x.href),D,C,B,A],onSubmit:function(i){function l(m,o){var n=f.selection.getRng();tinymce.util.Delay.setEditorTimeout(f,function(){f.windowManager.confirm(m,function(d){f.selection.setRng(n),o(d)})})}function k(){var d={href:j,target:x.target?x.target:null,rel:x.rel?x.rel:null,"class":x["class"]?x["class"]:null,title:x.title?x.title:null};I?(f.focus(),F&&x.text!=H&&("innerText" in I?I.innerText=x.text:I.textContent=x.text),a.setAttribs(I,d),c.select(I),f.undoManager.add()):F?f.insertContent(a.createHTML("a",d,a.encode(x.text))):f.execCommand("mceInsertLink",!1,d)}var j;return x=tinymce.extend(x,i.data),(j=x.href)?j.indexOf("@")>0&&-1==j.indexOf("//")&&-1==j.indexOf("mailto:")?void l("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(b){b&&(j="mailto:"+j),k()}):f.settings.link_assume_external_targets&&!/^\w+:/i.test(j)||!f.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(j)?void l("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(b){b&&(j="http://"+j),k()}):void k():void f.execCommand("unlink")}})}f.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:e(g),stateSelector:"a[href]"}),f.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),f.addShortcut("Meta+K","",e(g)),f.addCommand("mceLink",e(g)),this.showDialog=g,f.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:e(g),stateSelector:"a[href]",context:"insert",prependToContext:!0})});